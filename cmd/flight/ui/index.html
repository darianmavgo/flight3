<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight3 Rclone Browser</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --item-hover: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #38bdf8;
            --accent-hover: #0ea5e9;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        aside {
            width: 250px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
        }

        aside h2 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--accent);
            font-weight: 600;
        }

        .remote-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
        }

        .remote-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
        }

        .remote-item:hover,
        .remote-item.active {
            background-color: var(--item-hover);
            color: var(--text-primary);
        }

        main {
            flex: 1;
            padding: 20px 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            align-items: bottom;
            margin-bottom: 20px;
            gap: 15px;
            border-bottom: 1px solid #334155;
            padding-bottom: 20px;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .breadcrumb {
            display: flex;
            gap: 8px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            align-items: center;
        }

        .breadcrumb span {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .breadcrumb span:hover {
            color: var(--text-primary);
            background: var(--item-hover);
        }

        .breadcrumb-sep {
            color: #64748b;
            cursor: default !important;
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px;
            padding-top: 10px;
        }

        .file-item {
            background: transparent;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s, background 0.2s;
            border: 1px solid transparent;
        }

        .file-item:hover {
            background: #1e293b;
            border-color: #334155;
        }

        .file-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .file-name {
            font-size: 0.85rem;
            word-break: break-word;
            line-height: 1.3;
        }

        .file-meta {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 5px;
        }

        .error {
            color: #f87171;
            padding: 15px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(239, 68, 68, 0.2);
            margin-bottom: 20px;
        }

        .btn-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(56, 189, 248, 0.1);
            transition: background 0.2s;
            display: inline-block;
            text-align: center;
        }

        .btn-link:hover {
            background: rgba(56, 189, 248, 0.2);
        }
    </style>
</head>

<body>
    <aside>
        <h2>Rclone Browser</h2>
        <ul id="remoteList" class="remote-list">
            <li class="remote-item" style="cursor: default;">Loading...</li>
        </ul>
        <div style="margin-top: 20px; text-align: right;">
            <button onclick="window.open('/_/', '_blank')" class="btn-link" style="font-size: 0.8em;">+ Remote
                (Admin)</button>
        </div>

        <h2 style="margin-top: 30px;">Pipelines</h2>
        <ul id="pipelineList" class="remote-list">
            <!-- Pipelines go here -->
            <li class="remote-item" style="cursor: default; opacity: 0.5;">Loading...</li>
        </ul>
        <div style="margin-top: 10px; text-align: right;">
            <!-- For now, creation via Admin UI is safest/easiest -->
            <button onclick="window.open('/_/#/collections?collectionId=data_pipelines', '_blank')" class="btn-link"
                style="font-size: 0.8em;">+ Pipeline (Admin)</button>
        </div>

        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #334155;">
            <!-- Footer info -->
        </div>
    </aside>
    <main>
        <header>
            <div>
                <h1 id="currentRemoteTitle">Select a Remote or Pipeline</h1>
                <div id="breadcrumbs" class="breadcrumb" style="margin-top: 10px;"></div>
            </div>
            <div id="actions" style="margin-left: auto; align-self: center;">
                <!-- Dynamic Actions -->
            </div>
        </header>

        <div id="errorBox" class="error" style="display: none;"></div>
        <div id="fileGrid" class="file-grid">
            <div style="color: var(--text-secondary); grid-column: 1/-1; text-align: center; margin-top: 50px;">
                Select a remote or pipeline from the sidebar.
            </div>
        </div>
    </main>

    <script>
        const API_BASE = '/api/rclone';
        const PB_API = '/api';

        let currentRemoteId = null;
        let currentPipelineId = null;
        let currentPath = '';

        async function init() {
            await Promise.all([loadRemotes(), loadPipelines()]);
        }

        async function loadRemotes() {
            try {
                const res = await fetch(`${PB_API}/collections/rclone_remotes/records?sort=name`);
                if (!res.ok) throw new Error("Failed");
                const data = await res.json();
                const list = document.getElementById('remoteList');
                list.innerHTML = '';

                if (data.items && data.items.length > 0) {
                    data.items.forEach(remote => {
                        const li = document.createElement('li');
                        li.className = 'remote-item';
                        li.id = `remote-${remote.id}`;
                        li.innerHTML = `<span>‚òÅÔ∏è</span> ${remote.name}`;
                        li.onclick = () => selectRemote(remote);
                        list.appendChild(li);
                    });
                } else {
                    list.innerHTML = '<li class="remote-item" style="cursor: default;">No remotes found.</li>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadPipelines() {
            try {
                const res = await fetch(`${PB_API}/collections/data_pipelines/records?sort=name`);
                if (!res.ok) throw new Error("Failed");
                const data = await res.json();
                const list = document.getElementById('pipelineList');
                list.innerHTML = '';

                if (data.items && data.items.length > 0) {
                    data.items.forEach(p => {
                        const li = document.createElement('li');
                        li.className = 'remote-item';
                        li.id = `pipeline-${p.id}`;
                        li.innerHTML = `<span>üöÄ</span> ${p.name}`;
                        li.onclick = () => selectPipeline(p);
                        list.appendChild(li);
                    });
                } else {
                    list.innerHTML = '<li class="remote-item" style="cursor: default; font-size: 0.9em;">No pipelines.</li>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function selectRemote(remote) {
            currentRemoteId = remote.id;
            currentPipelineId = null;
            currentPath = '';
            document.getElementById('currentRemoteTitle').textContent = remote.name;
            document.getElementById('actions').innerHTML = '';

            updateSidebarSelection('remote', remote.id);
            loadPath(currentRemoteId, currentPath);
        }

        function selectPipeline(pipeline) {
            currentPipelineId = pipeline.id;
            currentRemoteId = null;
            document.getElementById('currentRemoteTitle').textContent = pipeline.name;
            document.getElementById('breadcrumbs').innerHTML = 'Pipeline View'; // TODO: Status?

            updateSidebarSelection('pipeline', pipeline.id);

            // Show Pipeline Actions
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = ''; // clear grid

            const banquetUrl = `/banquet/${pipeline.name}/tb0`;
            const container = document.getElementById('actions');
            container.innerHTML = `
                <a href="${banquetUrl}" target="_blank" class="btn-link" style="background: var(--accent); color: #fff;">Open Data Table ‚Üó</a>
            `;

            grid.innerHTML = `
                <div style="grid-column: 1/-1; padding: 20px; background: #1e293b; border-radius: 8px;">
                    <h3>Pipeline Details</h3>
                    <p style="color: var(--text-secondary)"><strong>Banquet URL:</strong> <a href="${banquetUrl}" target="_blank" style="color: var(--accent)">${banquetUrl}</a></p>
                    <p style="color: var(--text-secondary)">This pipeline fetches data from Rclone and converts it using MkSQLite.</p>
                </div>
            `;
            document.getElementById('errorBox').style.display = 'none';
        }

        function updateSidebarSelection(type, id) {
            document.querySelectorAll('.remote-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`${type}-${id}`);
            if (activeEl) activeEl.classList.add('active');
        }

        async function loadPath(remoteId, path) {
            currentPath = path;
            renderBreadcrumbs();
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '<p style="color: var(--text-secondary)">Loading contents...</p>';
            document.getElementById('errorBox').style.display = 'none';

            try {
                const url = `${API_BASE}/browse/${remoteId}?path=${encodeURIComponent(path)}`;
                const res = await fetch(url);
                if (!res.ok) {
                    let errData;
                    try { errData = await res.json(); } catch (e) { }
                    throw new Error((errData && errData.error) || res.statusText);
                }
                const files = await res.json();
                renderFiles(files);
            } catch (e) {
                grid.innerHTML = '';
                showError(e.message);
            }
        }

        function renderFiles(files) {
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '';

            if (files.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-secondary)">Empty directory</p>';
                return;
            }

            // Sort: folders first
            files.sort((a, b) => (b.isDir - a.isDir) || a.name.localeCompare(b.name));

            files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `
                    <div class="file-icon">${file.isDir ? 'üìÅ' : 'üìÑ'}</div>
                    <div class="file-name">${file.name}</div>
                    ${!file.isDir ? `<div class="file-meta">${formatSize(file.size)}</div>` : ''}
                `;
                div.onclick = () => {
                    if (file.isDir) {
                        const newPath = currentPath ? `${currentPath}/${file.name}` : file.name;
                        loadPath(currentRemoteId, newPath);
                    } else {
                        // File click: copy path to clipboard for pipeline creation
                        if (confirm(`Copy path "${file.name}" to clipboard?`)) {
                            const fullP = currentPath ? `${currentPath}/${file.name}` : file.name;
                            navigator.clipboard.writeText(fullP);
                        }
                    }
                };
                grid.appendChild(div);
            });
        }

        function renderBreadcrumbs() {
            const container = document.getElementById('breadcrumbs');
            container.innerHTML = `<span onclick="loadPath('${currentRemoteId}', '')">ROOT</span>`;

            if (!currentPath) return;

            const parts = currentPath.split('/');
            let accum = '';
            parts.forEach((part, i) => {
                accum += (i === 0 ? '' : '/') + part;
                const pathRef = accum;
                container.innerHTML += ` <span class="breadcrumb-sep">/</span> <span onclick="loadPath('${currentRemoteId}', '${pathRef}')">${part}</span>`;
            });
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showError(msg) {
            const box = document.getElementById('errorBox');
            box.textContent = msg;
            box.style.display = 'block';
        }

        init();
    </script>
</body>

</html>